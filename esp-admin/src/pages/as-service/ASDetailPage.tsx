import { useState } from 'react';
import {
  Card,
  Descriptions,
  Tag,
  Button,
  Space,
  Select,
  DatePicker,
  Input,
  Alert,
  Divider,
  Typography,
  Modal,
  message,
  Image,
  Spin,
} from 'antd';
import {
  ArrowLeftOutlined,
  FileTextOutlined,
  EditOutlined,
} from '@ant-design/icons';
import dayjs from 'dayjs';
import {
  useASDetail,
  useUpdateASStatus,
  useAssignDealer,
  useDealerOptions,
} from '../../api/as-service.api';
import { formatDateTime, formatDate } from '../../utils/formatters';
import { AS_STATUS_LABELS, AS_STATUS_COLORS } from '../../utils/constants';
import { useAuthStore } from '../../stores/authStore';
import type { ASStatus, FaultType } from '../../types/as-service.types';

const { Title, Text } = Typography;
const { TextArea } = Input;

const FAULT_TYPE_LABELS: Record<FaultType, string> = {
  POWER: '전원불량',
  SPARK: '스파크',
  TEMPERATURE: '온도이상',
  COMM_ERROR: '통신오류',
  NOISE: '소음',
  OTHER: '기타',
};

const URGENCY_LABELS: Record<string, string> = {
  HIGH: '긴급',
  NORMAL: '일반',
};

// 상태 전이 규칙
const STATUS_TRANSITIONS: Record<string, Record<string, ASStatus[]>> = {
  ADMIN: {
    PENDING: ['ACCEPTED'],
    ACCEPTED: ['ASSIGNED'],
    ASSIGNED: ['IN_PROGRESS'],
    IN_PROGRESS: ['COMPLETED'],
    REPORT_SUBMITTED: ['CLOSED'],
  },
  DEALER: {
    PENDING: ['ACCEPTED'],
    ACCEPTED: ['ASSIGNED'],
    ASSIGNED: ['IN_PROGRESS'],
    IN_PROGRESS: ['COMPLETED'],
  },
};

interface ASDetailPageProps {
  requestId: number;
  onBack: () => void;
  onViewReport?: (requestId: number) => void;
  onWriteReport?: (requestId: number) => void;
}

export default function ASDetailPage({
  requestId,
  onBack,
  onViewReport,
  onWriteReport,
}: ASDetailPageProps) {
  const user = useAuthStore((s) => s.user);
  const role = user?.role ?? 'OWNER';

  const { data, isLoading } = useASDetail(requestId);
  const { data: dealerData } = useDealerOptions();
  const updateStatus = useUpdateASStatus();
  const assignDealer = useAssignDealer();

  const [selectedDealer, setSelectedDealer] = useState<number | undefined>();
  const [visitDate, setVisitDate] = useState<dayjs.Dayjs | null>(null);
  const [memo, setMemo] = useState('');

  const detail = data?.data;
  const dealerOptions = dealerData ?? [];

  if (isLoading) {
    return (
      <Card>
        <Spin />
      </Card>
    );
  }

  if (!detail) {
    return (
      <Card>
        <Text type="secondary">A/S 상세 정보를 찾을 수 없습니다.</Text>
        <br />
        <Button icon={<ArrowLeftOutlined />} onClick={onBack} style={{ marginTop: 16 }}>
          목록으로
        </Button>
      </Card>
    );
  }

  const allowedTransitions = STATUS_TRANSITIONS[role]?.[detail.status] ?? [];

  const handleStatusChange = (newStatus: ASStatus) => {
    Modal.confirm({
      title: '상태 변경',
      content: `상태를 "${AS_STATUS_LABELS[newStatus]}"(으)로 변경하시겠습니까?`,
      onOk: async () => {
        await updateStatus.mutateAsync({
          requestId,
          update: {
            status: newStatus,
            memo: memo || undefined,
            visitScheduledDatetime: visitDate?.toISOString(),
            dealerId: selectedDealer,
          },
        });
        message.success('상태가 변경되었습니다.');
        setMemo('');
      },
    });
  };

  const handleAssignDealer = () => {
    if (!selectedDealer) {
      message.warning('대리점을 선택해주세요.');
      return;
    }
    Modal.confirm({
      title: '대리점 배정',
      content: '선택한 대리점을 배정하시겠습니까?',
      onOk: async () => {
        await assignDealer.mutateAsync({ requestId, dealerId: selectedDealer });
        message.success('대리점이 배정되었습니다.');
      },
    });
  };

  const dateStr = dayjs(detail.createdAt).format('YYYYMMDD');
  const requestNumber = `AS-${dateStr}-${String(detail.requestId).slice(-3).padStart(3, '0')}`;

  const hasReport = detail.status === 'COMPLETED' || detail.status === 'REPORT_SUBMITTED' || detail.status === 'CLOSED';
  const canWriteReport = detail.status === 'COMPLETED' && (role === 'DEALER' || role === 'ADMIN');

  return (
    <div>
      <Space style={{ marginBottom: 16 }}>
        <Button icon={<ArrowLeftOutlined />} onClick={onBack}>
          목록으로
        </Button>
      </Space>

      {/* A/S 신청 정보 */}
      <Card title="A/S 신청 정보" style={{ marginBottom: 16 }}>
        <Descriptions column={{ xs: 1, sm: 2 }} bordered size="small">
          <Descriptions.Item label="접수번호">{requestNumber}</Descriptions.Item>
          <Descriptions.Item label="상태">
            <Tag color={AS_STATUS_COLORS[detail.status] ?? 'default'}>
              {AS_STATUS_LABELS[detail.status] ?? detail.status}
            </Tag>
          </Descriptions.Item>
          <Descriptions.Item label="매장명">{detail.store.storeName}</Descriptions.Item>
          <Descriptions.Item label="장비명">{detail.equipment.equipmentName}</Descriptions.Item>
          <Descriptions.Item label="고장 유형">
            {FAULT_TYPE_LABELS[detail.faultType] ?? detail.faultType}
          </Descriptions.Item>
          <Descriptions.Item label="긴급도">
            <Tag color={detail.urgency === 'HIGH' ? 'red' : 'blue'}>
              {URGENCY_LABELS[detail.urgency]}
            </Tag>
          </Descriptions.Item>
          <Descriptions.Item label="증상" span={2}>
            {detail.description}
          </Descriptions.Item>
          <Descriptions.Item label="담당자명">{detail.contactName}</Descriptions.Item>
          <Descriptions.Item label="연락처">{detail.contactPhone}</Descriptions.Item>
        </Descriptions>

        {/* 첨부파일 */}
        {detail.attachments.length > 0 && (
          <div style={{ marginTop: 16 }}>
            <Text strong>첨부파일</Text>
            <div style={{ marginTop: 8 }}>
              <Image.PreviewGroup>
                <Space>
                  {detail.attachments.map((att) => (
                    <Image
                      key={att.attachmentId}
                      width={100}
                      height={100}
                      style={{ objectFit: 'cover', borderRadius: 4 }}
                      src={att.filePath}
                      fallback="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABmJLR0QA/wD/AP+gvaeTAAAAb0lEQVR4nO3BAQ0AAADCoPd/aLMAQIgBAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBuEfAAASEaU3QAAAAASUVORK5CYII="
                      alt={att.fileName}
                    />
                  ))}
                </Space>
              </Image.PreviewGroup>
            </div>
          </div>
        )}
      </Card>

      {/* 방문 희망 일시 */}
      {detail.preferredVisitDatetime && (
        <Card style={{ marginBottom: 16 }}>
          <Title level={5} style={{ marginTop: 0 }}>방문 희망 일시</Title>
          <Text strong style={{ fontSize: 16 }}>
            {formatDateTime(detail.preferredVisitDatetime)}
          </Text>
          <Alert
            message="본 요청서에 기재된 고객 방문 희망 일시를 준수하여 방문해 주시기 바랍니다."
            type="info"
            showIcon
            style={{ marginTop: 12 }}
          />
        </Card>
      )}

      {/* 접수 일시 정보 */}
      <Card style={{ marginBottom: 16 }}>
        <Title level={5} style={{ marginTop: 0 }}>접수 일시</Title>
        <Text strong style={{ fontSize: 16 }}>
          {formatDateTime(detail.createdAt)}
        </Text>
        <Alert
          message="원활한 서비스를 위해 접수일로부터 3일~7일 이내에 고객 방문 및 AS처리를 진행해 주시기 바랍니다."
          type="warning"
          showIcon
          style={{ marginTop: 12 }}
        />
      </Card>

      {/* 처리 정보 (ADMIN/DEALER만) */}
      {(role === 'ADMIN' || role === 'DEALER') && (
        <Card title="처리 정보" style={{ marginBottom: 16 }}>
          {/* 대리점 배정 */}
          <div style={{ marginBottom: 16 }}>
            <Text strong style={{ display: 'block', marginBottom: 8 }}>
              담당 대리점 배정
            </Text>
            <Space>
              <Select
                placeholder="대리점 선택"
                style={{ width: 200 }}
                value={selectedDealer ?? detail.assignedDealer?.dealerId}
                onChange={setSelectedDealer}
                options={dealerOptions.map((d) => ({
                  value: d.dealerId,
                  label: d.dealerName,
                }))}
              />
              <Button
                type="primary"
                onClick={handleAssignDealer}
                loading={assignDealer.isPending}
                disabled={detail.status === 'COMPLETED' || detail.status === 'REPORT_SUBMITTED' || detail.status === 'CLOSED'}
              >
                배정
              </Button>
            </Space>
          </div>

          {/* 방문 예정 일시 */}
          <div style={{ marginBottom: 16 }}>
            <Text strong style={{ display: 'block', marginBottom: 8 }}>
              방문 예정 일시
            </Text>
            <DatePicker
              showTime
              format="YYYY-MM-DD HH:mm"
              value={visitDate ?? (detail.visitScheduledDatetime ? dayjs(detail.visitScheduledDatetime) : null)}
              onChange={setVisitDate}
              disabledDate={(current) => current && current < dayjs().startOf('day')}
              style={{ width: 250 }}
            />
          </div>

          {/* 처리 메모 */}
          <div style={{ marginBottom: 16 }}>
            <Text strong style={{ display: 'block', marginBottom: 8 }}>
              처리 메모
            </Text>
            <TextArea
              placeholder="처리 관련 메모를 입력하세요"
              value={memo}
              onChange={(e) => setMemo(e.target.value)}
              rows={3}
              maxLength={500}
            />
          </div>

          {/* 상태 변경 버튼 */}
          {allowedTransitions.length > 0 && (
            <div>
              <Divider />
              <Text strong style={{ display: 'block', marginBottom: 12 }}>
                상태 변경
              </Text>
              <Space wrap>
                {allowedTransitions.map((nextStatus) => (
                  <Button
                    key={nextStatus}
                    type="primary"
                    onClick={() => handleStatusChange(nextStatus)}
                    loading={updateStatus.isPending}
                  >
                    {AS_STATUS_LABELS[nextStatus]}(으)로 변경
                  </Button>
                ))}
              </Space>
            </div>
          )}

          {/* 보고서 작성/조회 버튼 */}
          {canWriteReport && (
            <>
              <Divider />
              <Button
                type="primary"
                icon={<EditOutlined />}
                onClick={() => onWriteReport?.(requestId)}
              >
                완료 보고서 작성
              </Button>
            </>
          )}
          {hasReport && detail.report && (
            <>
              {!canWriteReport && <Divider />}
              <Button
                icon={<FileTextOutlined />}
                onClick={() => onViewReport?.(requestId)}
                style={{ marginLeft: canWriteReport ? 8 : 0 }}
              >
                보고서 조회
              </Button>
            </>
          )}
        </Card>
      )}

      {/* HQ/OWNER: 읽기 전용 보고서 링크 */}
      {(role === 'HQ' || role === 'OWNER') && hasReport && detail.report && (
        <Card style={{ marginBottom: 16 }}>
          <Button
            type="primary"
            icon={<FileTextOutlined />}
            onClick={() => onViewReport?.(requestId)}
          >
            완료 보고서 조회
          </Button>
        </Card>
      )}

      {detail.memo && (
        <Card title="처리 메모" style={{ marginBottom: 16 }}>
          <Text>{detail.memo}</Text>
        </Card>
      )}
    </div>
  );
}
