import { useState, useCallback } from 'react';
import { Card, Switch, Button, Tag, Table, Space, Alert, Spin, Empty, Typography, Row, Col, message } from 'antd';
import { PoweroffOutlined, ReloadOutlined, ThunderboltOutlined, CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import { useUiStore } from '../../stores/uiStore';
import { useRealtimeSensorData } from '../../api/monitoring.api';
import { useSendControlCommand, useControlHistory } from '../../api/control.api';
import { showConfirmModal } from '../../components/common/ConfirmModal';
import { POWERPACK_ACTIONS, CONTROL_TARGET_LABELS, POWERPACK_ACTION_LABELS } from '../../types/control.types';
import type { ControlCommand, ControlTarget } from '../../types/control.types';
import { formatDateTime } from '../../utils/formatters';

const { Text, Title } = Typography;

// 제어 이력 액션 라벨
function getHistoryActionLabel(target: ControlTarget, action: number, value?: number): string {
  if (target === 0) return POWERPACK_ACTION_LABELS[action] ?? `action=${action}`;
  return `${CONTROL_TARGET_LABELS[target]} action=${action}${value !== undefined ? ` (${value})` : ''}`;
}

export default function ControlPowerPage() {
  const selectedEquipmentId = useUiStore((s) => s.selectedEquipmentId);
  const { data: realtimeData, isLoading: sensorLoading } = useRealtimeSensorData(selectedEquipmentId);
  const { data: historyData, isLoading: historyLoading } = useControlHistory(selectedEquipmentId);
  const sendCommand = useSendControlCommand();
  const [pendingCmds, setPendingCmds] = useState<Record<string, boolean>>({});

  const handlePowerControl = useCallback(
    (controllerId: string, controllerLabel: string, action: number) => {
      const actionLabel = action === POWERPACK_ACTIONS.ON ? '켜' : action === POWERPACK_ACTIONS.OFF ? '끄' : '리셋하';

      showConfirmModal({
        title: '전원 제어 확인',
        content: `파워팩 [${controllerLabel}]의 전원을 ${actionLabel}시겠습니까?`,
        onOk: () => {
          const key = `${controllerId}-power`;
          setPendingCmds((prev) => ({ ...prev, [key]: true }));

          sendCommand.mutate(
            {
              target: 0,
              action,
              equipmentId: realtimeData?.equipmentName?.split('#')[0]?.trim() ?? 'esp-001',
              controllerId,
            },
            {
              onSuccess: (res) => {
                if (res.result === 'SUCCESS') {
                  message.success(`${controllerLabel} ${POWERPACK_ACTION_LABELS[action]} 명령 성공`);
                } else {
                  message.error(`${controllerLabel} 제어 실패: ${res.failReason}`);
                }
                setPendingCmds((prev) => ({ ...prev, [key]: false }));
              },
              onError: () => {
                message.error('제어 명령 전송 실패');
                setPendingCmds((prev) => ({ ...prev, [key]: false }));
              },
            },
          );
        },
      });
    },
    [sendCommand, realtimeData],
  );

  const handleBatchPower = useCallback(
    (action: number) => {
      const actionLabel = action === POWERPACK_ACTIONS.ON ? '켜' : '끄';

      showConfirmModal({
        title: '일괄 전원 제어',
        content: `이 장비의 모든 파워팩 전원을 ${actionLabel}시겠습니까?`,
        onOk: () => {
          setPendingCmds((prev) => ({ ...prev, batch: true }));
          sendCommand.mutate(
            {
              target: 0,
              action,
              equipmentId: 'all',
              controllerId: 'all',
            },
            {
              onSuccess: (res) => {
                if (res.result === 'SUCCESS') {
                  message.success(`일괄 ${POWERPACK_ACTION_LABELS[action]} 명령 성공`);
                } else {
                  message.error(`일괄 제어 실패: ${res.failReason}`);
                }
                setPendingCmds((prev) => ({ ...prev, batch: false }));
              },
              onError: () => {
                message.error('일괄 제어 명령 전송 실패');
                setPendingCmds((prev) => ({ ...prev, batch: false }));
              },
            },
          );
        },
      });
    },
    [sendCommand],
  );

  // 제어 이력 테이블 (전원만 필터)
  const powerHistory = (historyData ?? []).filter((h) => h.target === 0);

  const historyColumns: ColumnsType<ControlCommand> = [
    {
      title: '시간',
      dataIndex: 'requestedAt',
      key: 'requestedAt',
      width: 170,
      render: (v: string) => formatDateTime(v),
    },
    {
      title: '대상',
      dataIndex: 'controllerIdMqtt',
      key: 'controllerIdMqtt',
      width: 100,
    },
    {
      title: '명령',
      key: 'action',
      width: 100,
      render: (_: unknown, record: ControlCommand) => getHistoryActionLabel(record.target, record.action, record.value),
    },
    {
      title: '결과',
      dataIndex: 'result',
      key: 'result',
      width: 90,
      render: (result: string) => {
        const colorMap: Record<string, string> = { SUCCESS: 'success', FAIL: 'error', PENDING: 'processing' };
        const labelMap: Record<string, string> = { SUCCESS: '성공', FAIL: '실패', PENDING: '대기중' };
        return <Tag color={colorMap[result] ?? 'default'}>{labelMap[result] ?? result}</Tag>;
      },
    },
    {
      title: '응답 시간',
      dataIndex: 'respondedAt',
      key: 'respondedAt',
      width: 170,
      render: (v: string | undefined) => (v ? formatDateTime(v) : '-'),
    },
    {
      title: '실패 사유',
      dataIndex: 'failReason',
      key: 'failReason',
      render: (v: string | undefined) => v ?? '-',
    },
  ];

  if (!selectedEquipmentId) {
    return <Empty description="좌측 트리에서 장비를 선택하세요" />;
  }

  if (sensorLoading) {
    return (
      <div style={{ textAlign: 'center', padding: 60 }}>
        <Spin size="large" />
        <div style={{ marginTop: 16 }}>
          <Text type="secondary">데이터를 불러오는 중...</Text>
        </div>
      </div>
    );
  }

  if (!realtimeData) {
    return <Empty description="장비 데이터가 없습니다" />;
  }

  return (
    <div>
      {/* 일괄 제어 */}
      <Card size="small" style={{ marginBottom: 16 }}>
        <Row justify="space-between" align="middle">
          <Col>
            <Title level={5} style={{ margin: 0 }}>
              <ThunderboltOutlined /> 일괄 전원 제어
            </Title>
            <Text type="secondary">이 장비의 모든 파워팩을 일괄 제어합니다</Text>
          </Col>
          <Col>
            <Space>
              <Button
                type="primary"
                icon={<PoweroffOutlined />}
                loading={!!pendingCmds['batch']}
                onClick={() => handleBatchPower(POWERPACK_ACTIONS.ON)}
              >
                전체 ON
              </Button>
              <Button
                danger
                icon={<PoweroffOutlined />}
                loading={!!pendingCmds['batch']}
                onClick={() => handleBatchPower(POWERPACK_ACTIONS.OFF)}
              >
                전체 OFF
              </Button>
            </Space>
          </Col>
        </Row>
      </Card>

      {/* 파워팩별 제어 */}
      <Row gutter={[16, 16]} style={{ marginBottom: 16 }}>
        {realtimeData.controllers.map((ctrl) => {
          const isPowerOn = ctrl.sensorData.ppPower === 1;
          const isOnline = ctrl.connectionStatus === 'ONLINE';
          const key = `${ctrl.controllerName}-power`;
          const isPending = !!pendingCmds[key];

          return (
            <Col xs={24} sm={12} lg={8} key={ctrl.controllerId}>
              <Card
                size="small"
                title={
                  <Space>
                    <ThunderboltOutlined />
                    <span>{ctrl.controllerName}</span>
                    {isOnline ? (
                      <Tag icon={<CheckCircleOutlined />} color="success">연결</Tag>
                    ) : (
                      <Tag icon={<CloseCircleOutlined />} color="error">끊김</Tag>
                    )}
                  </Space>
                }
              >
                {!isOnline && (
                  <Alert
                    type="warning"
                    message="통신 끊김 상태에서는 제어가 불가능할 수 있습니다."
                    style={{ marginBottom: 12 }}
                    showIcon
                  />
                )}

                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 }}>
                  <Space>
                    <Text>전원 상태:</Text>
                    <Tag color={isPowerOn ? 'success' : 'error'} style={{ fontSize: 14, padding: '2px 12px' }}>
                      {isPowerOn ? 'ON' : 'OFF'}
                    </Tag>
                  </Space>
                  <Switch
                    checked={isPowerOn}
                    loading={isPending}
                    checkedChildren="ON"
                    unCheckedChildren="OFF"
                    onChange={(checked) => {
                      handlePowerControl(
                        ctrl.controllerName,
                        ctrl.controllerName,
                        checked ? POWERPACK_ACTIONS.ON : POWERPACK_ACTIONS.OFF,
                      );
                    }}
                  />
                </div>

                <Button
                  block
                  icon={<ReloadOutlined />}
                  loading={isPending}
                  onClick={() => handlePowerControl(ctrl.controllerName, ctrl.controllerName, POWERPACK_ACTIONS.RESET)}
                >
                  파워팩 리셋
                </Button>
              </Card>
            </Col>
          );
        })}
      </Row>

      {/* 제어 이력 */}
      <Card size="small" title="전원 제어 이력">
        <Table
          columns={historyColumns}
          dataSource={powerHistory}
          rowKey="commandId"
          size="small"
          pagination={{ pageSize: 10, showSizeChanger: false }}
          loading={historyLoading}
        />
      </Card>
    </div>
  );
}
